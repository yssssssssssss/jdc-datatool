# 多绘图库扩展实现方案

## 📋 概述

为JDC数据分析工具添加多种绘图库支持，包括Plotly、Bokeh、Altair、Plotnine、Pyecharts等，实现更丰富的可视化功能。

## 🏗️ 架构设计

### 1. 插件化架构设计

```
backend/
├── visualization/
│   ├── __init__.py
│   ├── base_generator.py          # 基础生成器抽象类
│   ├── matplotlib_generator.py    # Matplotlib实现
│   ├── plotly_generator.py        # Plotly实现
│   ├── bokeh_generator.py         # Bokeh实现
│   ├── altair_generator.py        # Altair实现
│   ├── plotnine_generator.py      # Plotnine实现
│   ├── pyecharts_generator.py     # Pyecharts实现
│   └── factory.py                 # 生成器工厂类
└── visualization.py               # 主入口（保持向后兼容）
```

### 2. 基础抽象类设计

```python
from abc import ABC, abstractmethod
from typing import Dict, List, Any, Optional, Union
import pandas as pd

class BaseVisualizationGenerator(ABC):
    """可视化生成器基类"""
    
    @abstractmethod
    def get_supported_charts(self) -> List[str]:
        """返回支持的图表类型列表"""
        pass
    
    @abstractmethod
    def generate_chart(self, df: pd.DataFrame, config: Dict) -> Union[str, Dict]:
        """生成图表的统一接口"""
        pass
    
    @abstractmethod
    def get_output_format(self) -> str:
        """返回输出格式：'base64', 'html', 'json'等"""
        pass
```

## 🎨 各绘图库实现方案

### 1. Plotly扩展（已部分实现）

**优势**：
- 交互式图表
- 丰富的图表类型
- Web友好的HTML输出
- 3D可视化支持

**实现要点**：
```python
class PlotlyGenerator(BaseVisualizationGenerator):
    def get_supported_charts(self):
        return ['scatter', 'line', 'bar', 'histogram', 'pie', 'heatmap', 
                'box', 'violin', '3d_scatter', 'surface', 'candlestick', 
                'sunburst', 'treemap', 'parallel_coordinates']
    
    def get_output_format(self):
        return 'html'  # 返回HTML格式的交互式图表
```

### 2. Bokeh扩展

**优势**：
- 高性能交互式可视化
- 适合大数据集
- 丰富的交互工具
- 服务器应用支持

**实现要点**：
```python
class BokehGenerator(BaseVisualizationGenerator):
    def get_supported_charts(self):
        return ['scatter', 'line', 'bar', 'histogram', 'heatmap', 
                'contour', 'hexbin', 'network', 'geographic']
    
    def get_output_format(self):
        return 'html'  # 使用bokeh.embed.file_html
```

### 3. Altair扩展

**优势**：
- 基于Vega-Lite语法
- 声明式可视化
- 统计图表专长
- 简洁的API

**实现要点**：
```python
class AltairGenerator(BaseVisualizationGenerator):
    def get_supported_charts(self):
        return ['scatter', 'line', 'bar', 'histogram', 'area', 
                'boxplot', 'strip', 'density', 'facet', 'brush_link']
    
    def get_output_format(self):
        return 'html'  # 使用chart.to_html()
```

### 4. Plotnine扩展

**优势**：
- Python版本的ggplot2
- 图形语法
- 统计可视化
- 分层图形构建

**实现要点**：
```python
class PlotnineGenerator(BaseVisualizationGenerator):
    def get_supported_charts(self):
        return ['scatter', 'line', 'bar', 'histogram', 'density', 
                'boxplot', 'violin', 'facet_wrap', 'facet_grid']
    
    def get_output_format(self):
        return 'base64'  # 保存为图片后转base64
```

### 5. Pyecharts扩展

**优势**：
- 中文友好
- 丰富的主题
- 商业图表支持
- 地理可视化

**实现要点**：
```python
class PyechartsGenerator(BaseVisualizationGenerator):
    def get_supported_charts(self):
        return ['bar', 'line', 'pie', 'scatter', 'heatmap', 'radar', 
                'gauge', 'funnel', 'sankey', 'wordcloud', 'map', 'geo']
    
    def get_output_format(self):
        return 'html'  # 使用render_embed()
```

## 🔧 核心实现组件

### 1. 生成器工厂类

```python
class VisualizationFactory:
    """可视化生成器工厂"""
    
    _generators = {
        'matplotlib': MatplotlibGenerator,
        'plotly': PlotlyGenerator,
        'bokeh': BokehGenerator,
        'altair': AltairGenerator,
        'plotnine': PlotnineGenerator,
        'pyecharts': PyechartsGenerator,
    }
    
    @classmethod
    def create_generator(cls, library: str) -> BaseVisualizationGenerator:
        """创建指定库的生成器"""
        if library not in cls._generators:
            raise ValueError(f"不支持的绘图库: {library}")
        return cls._generators[library]()
    
    @classmethod
    def get_available_libraries(cls) -> List[str]:
        """获取可用的绘图库列表"""
        return list(cls._generators.keys())
```

### 2. 统一配置格式

```python
chart_config = {
    'chart_type': 'scatter',           # 图表类型
    'library': 'plotly',               # 绘图库选择
    'columns': ['x_col', 'y_col'],     # 数据列
    'title': '散点图',                 # 图表标题
    'theme': 'dark',                   # 主题（可选）
    'interactive': True,               # 是否交互式（可选）
    'export_format': 'html',           # 输出格式（可选）
    'custom_options': {                # 库特定选项
        'color_scale': 'viridis',
        'size_column': 'size_col'
    }
}
```

### 3. 智能库选择逻辑

```python
class SmartLibrarySelector:
    """智能绘图库选择器"""
    
    def select_best_library(self, chart_type: str, data_size: int, 
                          interactive_required: bool = False) -> str:
        """根据需求选择最佳绘图库"""
        
        # 交互式需求优先
        if interactive_required:
            if chart_type in ['3d_scatter', 'surface']:
                return 'plotly'
            elif data_size > 10000:
                return 'bokeh'  # 大数据集
            else:
                return 'plotly'
        
        # 特殊图表类型
        if chart_type in ['wordcloud', 'map', 'geo']:
            return 'pyecharts'
        elif chart_type in ['facet_wrap', 'facet_grid']:
            return 'plotnine'
        elif chart_type in ['network', 'geographic']:
            return 'bokeh'
        
        # 默认选择
        return 'matplotlib'
```

## 🔄 ChartAgent集成方案

### 1. 修改ChartAgent类

```python
class ChartAgent:
    def __init__(self):
        self.factory = VisualizationFactory()
        self.selector = SmartLibrarySelector()
    
    def generate_chart_with_library(self, df: pd.DataFrame, 
                                  user_request: str, 
                                  preferred_library: str = None) -> Dict:
        """使用指定或智能选择的绘图库生成图表"""
        
        # 1. 分析用户意图
        intent = self.analyze_user_intent(user_request, df)
        
        # 2. 选择绘图库
        if preferred_library:
            library = preferred_library
        else:
            library = self.selector.select_best_library(
                intent['chart_type'], 
                len(df),
                intent.get('interactive', False)
            )
        
        # 3. 生成图表
        generator = self.factory.create_generator(library)
        chart_config = {
            'chart_type': intent['chart_type'],
            'columns': intent['columns'],
            'title': intent.get('title', '数据图表'),
            'library': library
        }
        
        result = generator.generate_chart(df, chart_config)
        
        return {
            'chart': result,
            'library_used': library,
            'format': generator.get_output_format(),
            'config': chart_config
        }
```

### 2. API接口扩展

```python
# 在app.py中添加新的API端点
@app.route('/api/generate_chart_advanced', methods=['POST'])
def generate_chart_advanced():
    """高级图表生成接口"""
    data = request.json
    library = data.get('library', 'auto')  # 支持库选择
    interactive = data.get('interactive', False)
    
    # ... 处理逻辑
```

## 📦 依赖管理

### 1. requirements.txt扩展

```txt
# 现有依赖
matplotlib>=3.5.0
seaborn>=0.11.0
plotly>=5.0.0

# 新增依赖
bokeh>=2.4.0
altair>=4.2.0
plotnine>=0.8.0
pyecharts>=1.9.0
vega-datasets>=0.9.0  # Altair示例数据
```

### 2. 可选依赖处理

```python
class OptionalImportHandler:
    """处理可选依赖的导入"""
    
    @staticmethod
    def safe_import(module_name: str, package_name: str = None):
        """安全导入模块，失败时返回None"""
        try:
            return __import__(module_name)
        except ImportError:
            package = package_name or module_name
            print(f"警告: {package} 未安装，相关功能将不可用")
            return None
```

## 🎯 实施步骤

### 阶段1：基础架构搭建
1. 创建插件化目录结构
2. 实现基础抽象类
3. 创建工厂类和选择器
4. 重构现有Matplotlib代码

### 阶段2：核心库实现
1. 完善Plotly生成器
2. 实现Bokeh生成器
3. 实现Pyecharts生成器
4. 添加智能选择逻辑

### 阶段3：高级功能
1. 实现Altair生成器
2. 实现Plotnine生成器
3. 添加主题系统
4. 优化性能和错误处理

### 阶段4：集成测试
1. 更新ChartAgent集成
2. 扩展API接口
3. 添加前端库选择界面
4. 全面测试各种场景

## 🔍 技术考虑

### 1. 输出格式统一
- **Base64图片**：Matplotlib, Plotnine
- **HTML嵌入**：Plotly, Bokeh, Altair, Pyecharts
- **JSON数据**：用于自定义渲染

### 2. 性能优化
- 延迟加载绘图库
- 缓存生成器实例
- 异步图表生成
- 内存管理优化

### 3. 错误处理
- 优雅的库缺失处理
- 图表生成失败回退
- 详细的错误日志
- 用户友好的错误信息

## 🎨 用户体验增强

### 1. 前端界面扩展
- 绘图库选择下拉菜单
- 图表类型预览
- 实时参数调整
- 导出格式选择

### 2. 智能推荐
- 基于数据特征推荐库
- 基于用户历史偏好
- 性能vs效果权衡提示

这个方案提供了完整的多绘图库扩展架构，既保持了向后兼容性，又为未来扩展提供了灵活的框架。您觉得这个方案如何？需要我详细实现某个特定部分吗？
